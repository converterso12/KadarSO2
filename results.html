<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hasil Perhitungan SO2</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 20px;
            margin: 0;
        }
        .container {
            width: 90%;
            max-width: 1000px;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 12px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #28a745;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        button {
            display: block;
            width: 100%;
            padding: 10px;
            background-color: #28a745;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background-color: #218838;
        }
        .table-container {
            margin-bottom: 20px;
        }
        .delete-btn {
            background-color: #dc3545;
            margin-top: 5px;
        }
        .delete-btn:hover {
            background-color: #c82333;
        }
        .delete-all-btn {
            background-color: #dc3545;
            margin-top: 20px;
        }
        .delete-all-btn:hover {
            background-color: #c82333;
        }
    </style>
    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const repo = 'converterso12/so2-calculation-data';
            const path = 'data.json';
            const token = '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';
            const url = `https://api.github.com/repos/${repo}/contents/${path}`;
            const data = await fetchJSON(url, token);

            // Decode content from Base64
            const content = JSON.parse(atob(data.content));

            // Mengelompokkan hasil berdasarkan tanggal
            const groupedResults = content.reduce((acc, result) => {
                const [date, time] = result.time.split('T');
                if (!acc[date]) {
                    acc[date] = [];
                }
                acc[date].push({ ...result, time });
                return acc;
            }, {});

            // Mengurutkan hasil berdasarkan tanggal
            const sortedDates = Object.keys(groupedResults).sort((a, b) => new Date(a) - new Date(b));

            // Membuat tabel untuk setiap kelompok tanggal
            sortedDates.forEach(date => {
                const tableContainer = document.createElement('div');
                tableContainer.className = 'table-container';
                const tableHeader = `<h2>Hasil pada ${date}</h2>`;
                const tableHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Tanggal</th>
                                <th>Waktu</th>
                                <th>V1</th>
                                <th>Pt</th>
                                <th>Kadar SO2</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${groupedResults[date].map((result, index) => `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${date}</td>
                                    <td>${result.time}</td>
                                    <td>${result.V1}</td>
                                    <td>${result.Pt}</td>
                                    <td>${result.so2}%</td>
                                    <td><button class="delete-btn" onclick="deleteEntry('${result.time}', '${date}')">Hapus</button></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <button class="delete-btn" onclick="deleteByDate('${date}')">Hapus Semua Data pada ${date}</button>
                `;
                tableContainer.innerHTML = tableHeader + tableHTML;
                resultsContainer.appendChild(tableContainer);
            });
        });

        async function fetchJSON(url, token) {
            const response = await fetch(url, {
                headers: {
                    'Authorization': `token ${token}`
                }
            });
            return response.json();
        }

        async function updateJSON(url, data, token, sha) {
            const response = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/vnd.github.v3+json'
                },
                body: JSON.stringify({
                    message: 'Update data.json',
                    content: btoa(JSON.stringify(data, null, 2)),
                    sha: sha
                })
            });
            return response.json();
        }

        function deleteEntry(time, date) {
            if (confirm('Apakah Anda yakin ingin menghapus data ini?')) {
                const repo = 'converterso12/so2-calculation-data';
                const path = 'data.json';
                const token = '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';
                const url = `https://api.github.com/repos/${repo}/contents/${path}`;

                fetchJSON(url, token).then(data => {
                    const content = JSON.parse(atob(data.content));

                    const updatedContent = content.filter(item => item.time !== time);

                    return updateJSON(url, updatedContent, token, data.sha);
                }).then(() => {
                    window.location.reload();
                });
            }
        }

        function deleteByDate(date) {
            if (confirm(`Apakah Anda yakin ingin menghapus semua data pada ${date}?`)) {
                const repo = 'converterso12/so2-calculation-data';
                const path = 'data.json';
                const token = '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';
                const url = `https://api.github.com/repos/${repo}/contents/${path}`;

                fetchJSON(url, token).then(data => {
                    const content = JSON.parse(atob(data.content));

                    const updatedContent = content.filter(item => !item.time.startsWith(date));

                    return updateJSON(url, updatedContent, token, data.sha);
                }).then(() => {
                    window.location.reload();
                });
            }
        }

        function deleteAll() {
            if (confirm('Apakah Anda yakin ingin menghapus semua data?')) {
                const repo = 'converterso12/so2-calculation-data';
                const path = 'data.json';
                const token = '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';
                const url = `https://api.github.com/repos/${repo}/contents/${path}`;

                fetchJSON(url, token).then(data => {
                    const newContent = btoa(JSON.stringify([], null, 2));
                    return updateJSON(url, [], token, data.sha);
                }).then(() => {
                    window.location.reload();
                });
            }
        }
    </script>
</head>
<body>
    <div class="container">
        <h1>Hasil Perhitungan Kadar SO2</h1>
        <div id="resultsContainer"></div>
        <button class="delete-all-btn" onclick="deleteAll()">Hapus Semua Data</button>
        <button onclick="window.location.href='index.html'">Kembali</button>
    </div>
</body>
</html>